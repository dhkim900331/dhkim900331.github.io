I"‚›<h2 id="1-overview">1. Overview</h2>

<p>JOL(Java Layout Object) Library ì‚¬ìš©ë²•</p>
<p style="height:40px;"></p>
<h2 id="2-description">2. Description</h2>

<p>Java ê°ì²´ì˜ ì‹¤ì œ í¬ê¸°ë¥¼ Inspect í•˜ê¸° ìœ„í•´ì„œëŠ” Instrumentation ì„ í™œìš©í•  ìˆ˜ ìˆìœ¼ë‚˜,</p>

<p>ì´ëŠ” Shallow sizeë§Œ ì•Œì•„ë‚¼ ìˆ˜ ìˆë‹¤.</p>

<p>ì‹¤ì œ Sizeë¥¼ Heap dumpë³´ë‹¤ ì •í™•í•˜ê²Œ ì¶”ì í•  ìˆ˜ ìˆë‹¤ê³  ì†Œê°œí•˜ëŠ” JOL ì„ ì‚¬ìš©í•´ë³´ì.</p>
<p style="height:40px;"></p>
<h2 id="3-use">3. Use</h2>

<p><a href="https://builds.shipilev.net/jol/">ìµœì‹ ë²„ì „ì„ ë‹¤ìš´ë¡œë“œ</a> í•˜ì—¬ WEB-INF/lib ì— ìœ„ì¹˜ì‹œí‚¨ë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="31-my-app">3.1 My App</h3>

<p>ì•„ë˜ì™€ ê°™ì€ Business Java code ê°€ ìˆë‹¤ê³  ê°€ì •í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>   <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;();</span>
    <span class="kt">int</span> <span class="n">addedNum</span> <span class="o">=</span> <span class="mi">500</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">addedByte</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kt">byte</span><span class="o">[]</span> <span class="n">objectInSession</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">addedByte</span><span class="o">];</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">addedNum</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
      <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">objectInSession</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">sList</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;)</span><span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"listSession"</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">sList</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
      <span class="n">sList</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">else</span><span class="o">{</span>
      <span class="n">sList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"listSession"</span><span class="o">,</span> <span class="n">sList</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>App ë°˜ë³µ ìš”ì²­ ì‹œ, ë§¤íšŒ ArrayListë¡œ ì´ë£¨ì–´ì§„ 500 bytes dataë¥¼ ëˆ„ì í•˜ì—¬ Sessionì— ì €ì¥í•œë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="32-import-jol">3.2 Import JOL</h3>

<p>ì´ë•Œ, Session ì— ì €ì¥ë˜ëŠ” ì‹¤ì œ sizeë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´,</p>

<p>ë‹¤ìŒì˜ JOL library import í•œë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.openjdk.jol.info.ClassLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.info.GraphLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.vm.VM</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:40px;"></p>
<h4 id="33-specified-field-size-in-vm">3.3 Specified Field Size in VM</h4>

<p><code class="language-plaintext highlighter-rouge">System.out.println(VM.current().details());</code> í˜¸ì¶œ ì‹œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre># VM mode: 64 bits
# Compressed references (oops): 3-bit shift
# Compressed class pointers: 3-bit shift
# WARNING | Compressed references base/shifts are guessed by the experiment!
# WARNING | Therefore, computed addresses are just guesses, and ARE NOT RELIABLE.
# WARNING | Make sure to attach Serviceability Agent to get the reliable addresses.
# Object alignment: 8 bytes
#                       ref, bool, byte, char, shrt,  int,  flt,  lng,  dbl
# Field sizes:            4,    1,    1,    2,    2,    4,    4,    8,    8
# Array element sizes:    4,    1,    1,    2,    2,    4,    4,    8,    8
# Array base offsets:    16,   16,   16,   16,   16,   16,   16,   16,   16
</pre></td></tr></tbody></table></code></pre></div></div>

<p>byteê°€ memoryì—ì„œ 1 byteë¥¼ ì°¨ì§€í•œë‹¤ê³  ì•Œ ìˆ˜ ìˆë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="34-shallow-size-of-arraylist">3.4 Shallow Size of ArrayList</h3>

<p><code class="language-plaintext highlighter-rouge">System.out.println(ClassLayout.parseInstance(sList).toPrintable());</code> í˜¸ì¶œ ì‹œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>java.util.ArrayList object internals:
OFF  SZ                 TYPE DESCRIPTION               VALUE
  0   8                      (object header: mark)     0x0000000000000005 (biasable; age: 0)
  8   4                      (object header: class)    0x000179d0
 12   4                  int AbstractList.modCount     500
 16   4                  int ArrayList.size            500
 20   4   java.lang.Object[] ArrayList.elementData     [[0], [0], ... more 400+
 
 ...
 
 Instance size: 24 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ClassLayoutì€ Object ë˜ëŠ” Class ìì²´ì˜ Size(Shallow size)ë§Œì„ ê³„ì‚°í•œë‹¤ê³  í•˜ê¸° ë•Œë¬¸ì—, ArrayList.size=500 ì„ì—ë„ ë§¤ìš° ì‘ì€ 24 bytes ë¡œ ë³´ì—¬ì§„ë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="35-shallow-size-of-array-in-arraylist">3.5 Shallow Size of Array in ArrayList</h3>

<p><code class="language-plaintext highlighter-rouge">System.out.println(ClassLayout.parseInstance(sList.toArray()).toPrintable());</code> í˜¸ì¶œ ì‹œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>[Ljava.lang.Object; object internals:
OFF  SZ               TYPE DESCRIPTION               VALUE
  0   8                    (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4                    (object header: class)    0x00011840
 12   4                    (array length)            500
 16 2000   java.lang.Object Object;.&lt;elements&gt;        N/A
Instance size: 2016 bytes
</pre></td></tr></tbody></table></code></pre></div></div>

<p>toArray() ë¥¼ ì¡°ì‚¬í•œ ê²°ê³¼, Shallow Size ì„ì—ë„ 2016 bytes ë¼ëŠ” ì „ì²´ ì‹¤ì œ Sizeë¡œ ë³´ì¸ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="36-shallow-size-of-single-object-in-arraylist">3.6 Shallow Size of Single Object in ArrayList</h3>

<p><code class="language-plaintext highlighter-rouge">System.out.println(ClassLayout.parseInstance(sList.toArray()[0]).toPrintable());</code> í˜¸ì¶œ ì‹œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>[B object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4        (object header: class)    0x000007a8
 12   4        (array length)            1
 16   1   byte [B.&lt;elements&gt;             N/A
 17   7        (object alignment gap)
Instance size: 24 bytes
Space losses: 0 bytes internal + 7 bytes external = 7 bytes total
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">byte[] objectInSession</code> Objectì˜ SizeëŠ” 24 bytes ì´ë©°, ë‚´ë¶€ì— <code class="language-plaintext highlighter-rouge">new byte[addedByte];</code> ìœ¼ë¡œ ìƒì„±í•œ 1 byte ê°€ í™•ì¸ëœë‹¤.</p>
<p style="height:20px;"></p>
<p>ì—¬ê¸°ê¹Œì§€ì˜ ë‚´ìš©ìœ¼ë¡œëŠ” ëª¨ë“  Objectì˜ Sizeë¥¼ ì¶”ì í•˜ì—¬, ì‹¤ì œ Session data sizeë¥¼ í™•ì¸í•  ìˆ˜ ìˆì„ ê²ƒ ê°™ì•˜ì§€ë§Œ ë‚œí•´í•˜ì˜€ê³ ,</p>

<p>ClassLayoutì€ ì¡°ì‚¬í•˜ëŠ” Object ìì²´ë§Œì˜ Shallow Sizeë¥¼ ë³´ì—¬ì¤€ë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="37-retained-size-of-arraylist">3.7 Retained Size of ArrayList</h3>

<p>GraphLayoutì„ ì´ìš©í•˜ë©´, ì²« ì§„ì…ì ë¶€í„° ë‹¿ì„ ìˆ˜ ìˆëŠ” Deep í•œ ê³³ê¹Œì§€ì˜ ëª¨ë“  Sizeë¥¼ ì¡°ì‚¬í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤.</p>

<p>ClassLayoutì„ ì´ìš©í•˜ë©´ Accurate Sizeë¥¼ ì–»ì„ ìˆ˜ ì—†ë‹¤.</p>
<p style="height:20px;"></p>
<p><code class="language-plaintext highlighter-rouge">System.out.println(GraphLayout.parseInstance(sList).toPrintable());</code> í˜¸ì¶œ ì‹œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>java.util.ArrayList@4513a2d0d object externals:
          ADDRESS       SIZE TYPE                PATH                           VALUE
        7d56522c0         24 java.util.ArrayList                                (object)
        7d56522d8         24 [B                  .elementData[0]                [0]
        7d56522f0       4520 (something else)    (somewhere else)               (something else)
        7d5653498       2216 [Ljava.lang.Object; .elementData                   [[0], [0], ... more 400+
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ì–´ë””ê¹Œì§€ ë‹¿ì•˜ëŠ”ì§€ ëª¨ë¥¼ something else (4520 size) ì™¸ì— ArrayList (2216 size)ê°€ í™•ì¸ëœë‹¤.</p>

<p>ìµœì†Œí•œ Appì—ì„œ ìƒì„±í•œ Session data sizeëŠ” 2216 bytes ì´ìƒì´ ì•„ë‹ê¹Œ?</p>
<p style="height:20px;"></p>
<p>ìš°ë¦¬ê°€ Sessionì— ë„£ì€ Objectê°€ ì•„ë‹ˆë¼ Session ìì²´ë¥¼ ì¡°ì‚¬í•˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜?</p>
<p style="height:40px;"></p>
<h3 id="38-retained-size-of-httpsession">3.8 Retained Size of HttpSession</h3>

<p><code class="language-plaintext highlighter-rouge">System.out.println(GraphLayout.parseInstance(session).toPrintable());</code> í˜¸ì¶œ ì‹œ</p>

<p>OOME ìœ¼ë¡œ ì£½ì—ˆë‹¤.</p>
<p style="height:20px;"></p>
<p><code class="language-plaintext highlighter-rouge">System.out.println(GraphLayout.parseInstance(session).totalSize());</code> í˜¸ì¶œ ì‹œ</p>

<p>92958432 , ì¦‰ 88 Mbytes ë¡œ í™•ì¸ëœë‹¤.</p>
<p style="height:20px;"></p>
<p>1 Userê°€ ìƒì„±í•œ 1 Sessionì˜ ìˆœìˆ˜ í¬ê¸°ë¥¼ ì•Œê³  ì‹¶ì§€ë§Œ, Retained ëŠ” ì—°ê²°ëœ ëª¨ë“  Objectë¥¼ ì¶”ì í•˜ì—¬ì„œ ê·¸ëŸ°ì§€, ë§¤ìš° í° MB Sizeê°€ ë‚˜ì™”ë‹¤.</p>

<p>ì´ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ ArrayListë¥¼ ê±·ì–´ë‚´ê³ , ì¢€ ë” ë‹¨ìˆœí•œ êµ¬ì¡°ì—ì„œ í™•ì¸í•´ë³´ëŠ” í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•´ë³´ì¸ë‹¤.</p>
<p style="height:20px;"></p>
<p>ê·¸ë¦¬í•˜ì—¬, ë‹¤ìŒê³¼ ê°™ì´ My Appì„ ìˆ˜ì •í•˜ì˜€ë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">javax.servlet.http.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebServlet</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jol.info.ClassLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.info.GraphLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.vm.VM</span><span class="o">;</span>

<span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/SessionServlet"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SessionServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
  
    <span class="nc">HttpSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">byteSession</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"byteSession"</span><span class="o">);</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">_obj</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">500</span><span class="o">];</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">_tmp</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  
    <span class="k">if</span> <span class="o">(</span><span class="n">byteSession</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
      <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"byteSession"</span><span class="o">,</span> <span class="n">_obj</span><span class="o">);</span>
      <span class="n">byteSession</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"byteSession"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">else</span><span class="o">{</span>
      <span class="n">_tmp</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">_obj</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">byteSession</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">_obj</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_tmp</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_obj</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">byteSession</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">_tmp</span><span class="o">,</span> <span class="n">_obj</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">byteSession</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
      <span class="n">session</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"byteSession"</span><span class="o">,</span> <span class="n">_tmp</span><span class="o">);</span>
      <span class="n">byteSession</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">session</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"byteSession"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">String</span> <span class="n">log</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">et</span> <span class="o">=</span> <span class="s">"\n\r"</span><span class="o">;</span>
    <span class="k">if</span><span class="o">(</span><span class="n">_obj</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"_obj.length = "</span> <span class="o">+</span> <span class="n">_obj</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"ObjectSizeAgent.getObjectSize(_obj) = "</span> <span class="o">+</span> <span class="nc">ObjectSizeAgent</span><span class="o">.</span><span class="na">getObjectSize</span><span class="o">(</span><span class="n">_obj</span><span class="o">)</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="k">if</span><span class="o">(</span><span class="n">_tmp</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"_tmp.length = "</span> <span class="o">+</span> <span class="n">_tmp</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"ObjectSizeAgent.getObjectSize(_tmp) = "</span> <span class="o">+</span> <span class="nc">ObjectSizeAgent</span><span class="o">.</span><span class="na">getObjectSize</span><span class="o">(</span><span class="n">_tmp</span><span class="o">)</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span><span class="o">(</span><span class="n">byteSession</span><span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"byteSession.length = "</span> <span class="o">+</span> <span class="o">((</span><span class="n">byteSession</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">byteSession</span><span class="o">.</span><span class="na">length</span> <span class="o">+</span> <span class="n">et</span> <span class="o">:</span> <span class="s">""</span> <span class="o">+</span> <span class="n">et</span><span class="o">);</span>
      <span class="n">log</span> <span class="o">+=</span> <span class="s">"ObjectSizeAgent.getObjectSize(byteSession) = "</span> <span class="o">+</span> <span class="nc">ObjectSizeAgent</span><span class="o">.</span><span class="na">getObjectSize</span><span class="o">(</span><span class="n">byteSession</span><span class="o">)</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="n">log</span> <span class="o">+=</span> <span class="s">"ObjectSizeAgent.getObjectSize(session) = "</span> <span class="o">+</span> <span class="nc">ObjectSizeAgent</span><span class="o">.</span><span class="na">getObjectSize</span><span class="o">(</span><span class="n">session</span><span class="o">)</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">log</span><span class="o">+</span><span class="n">et</span><span class="o">);</span>
    
    <span class="kd">final</span> <span class="kt">long</span>  <span class="no">MEGABYTE</span> <span class="o">=</span> <span class="mi">1024L</span> <span class="o">*</span> <span class="mi">1024L</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">heapSize</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">/</span> <span class="no">MEGABYTE</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">heapMaxSize</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">maxMemory</span><span class="o">()</span> <span class="o">/</span> <span class="no">MEGABYTE</span><span class="o">;</span>
    <span class="kt">long</span> <span class="n">heapFreeSize</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">()</span> <span class="o">/</span> <span class="no">MEGABYTE</span><span class="o">;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="n">log</span> <span class="o">+=</span> <span class="s">"heapSize (MB) = "</span> <span class="o">+</span> <span class="n">heapSize</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="n">log</span> <span class="o">+=</span> <span class="s">"heapMaxSize (MB) = "</span> <span class="o">+</span> <span class="n">heapMaxSize</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="n">log</span> <span class="o">+=</span> <span class="s">"heapSize (MB) = "</span> <span class="o">+</span> <span class="n">heapFreeSize</span> <span class="o">+</span> <span class="n">et</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">log</span><span class="o">);</span>
    
    <span class="c1">// _obj</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--- Layout : _obj ---"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_obj</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">GraphLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_obj</span><span class="o">).</span><span class="na">totalSize</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">et</span><span class="o">);</span>
    
    <span class="c1">// _tmp</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">_tmp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--- Layout : _tmp ---"</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_tmp</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">GraphLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_tmp</span><span class="o">).</span><span class="na">totalSize</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">et</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// byteSession</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--- Layout : byteSession ---"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">byteSession</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">GraphLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">byteSession</span><span class="o">).</span><span class="na">totalSize</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">et</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>ArrayList ë“±ì„ ê±·ì–´ë‚´ê³ , ìˆœìˆ˜ Byte Array ë¡œë§Œ Sessionì— â€˜byteSessionâ€™ Key ì˜ Value ë¡œ ê°’ì„ ì €ì¥í•œë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="39-shallow-size-of-byte-array">3.9 Shallow Size of Byte Array</h3>

<p>ë°˜ë³µ í˜¸ì¶œ ì‹œë§ˆë‹¤ Sessionì— <code class="language-plaintext highlighter-rouge">byte[] _obj = new byte[500];</code> ë§Œí¼ì˜ Dataë¥¼ ì¦ë¶„ì‹œí‚¨ë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">_obj</code> ìì²´ì˜ Shallow/Retained SizeëŠ” ë‹¤ìŒì˜ Java code ë¡œ ì•Œ ìˆ˜ ìˆë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>    <span class="c1">// _obj</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--- Layout : _obj ---"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Shallow : "</span> <span class="o">+</span> <span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_obj</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Retained : "</span> <span class="o">+</span> <span class="nc">GraphLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">_obj</span><span class="o">).</span><span class="na">totalSize</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">et</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<blockquote>
  <p><code class="language-plaintext highlighter-rouge">_obj</code> ìì²´ì˜ ì…ì¥ì—ì„œëŠ”, ë” ì´ìƒ ë‹¿ì„ ê³³ì´ ì—†ëŠ” root ê·¸ ìì²´ì´ê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">520 bytes</code> ë¡œ í•­ìƒ ë™ì¼í•˜ê²Œ ì¸¡ì •ëœë‹¤.</p>
</blockquote>
<p style="height:20px;"></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>--- Layout : _obj ---
Shallow : [B object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4        (object header: class)    0x000007a8
 12   4        (array length)            500
 16 500   byte [B.&lt;elements&gt;             N/A
516   4        (object alignment gap)
Instance size: 520 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

Retained : 520
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>ìº¡ìŠí™”ë¥¼ ìœ„í•œ header(8+4=12 bytes)</p>

<p>_obj ë°°ì—´ í¬ê¸° Data 4 bytes</p>

<p>_obj ë°°ì—´ Data ìì²´ 500 bytes</p>

<p>ê·¸ë¦¬ê³  <strong>ObjectAlignmentInBytes</strong> , Data ì •ë ¬ì„ ìœ„í•œ gap ìœ¼ë¡œ 4 bytes ê°€ ì¶”ê°€ë˜ì–´</p>

<p>_obj ê°ì²´ ìì²´ì˜ ì´í¬ê¸°ëŠ” 520 bytes ê°€ ëœë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="310-what-is-objectalignmentinbytes">3.10 What is ObjectAlignmentInBytes?</h3>

<p>ì—¬ê¸°ì„œ ì ê¹, <strong>ObjectAlignmentInBytes</strong> ë¥¼ ì‚´í´ë³´ë©´,</p>

<p>JVMì—ì„œëŠ” Dataë¥¼ Heap ì— ì €ì¥í•  ë•Œ, 8 ~ 256 bytes ì˜ ë‹¨ìœ„ì˜ gap ì„ ìœ ì§€í•˜ë©° ì €ì¥í•œë‹¤.</p>

<p>í˜„ì¬ ë‚˜ì˜ í•´ë‹¹ ì„¤ì •ê°’ì€, 8 bytes ì´ë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>java <span class="nt">-XX</span>:+PrintFlagsFinal | <span class="nb">grep</span> <span class="s2">"ObjectAlignmentInBytes"</span>
     intx ObjectAlignmentInBytes                    <span class="o">=</span> 8                                   <span class="o">{</span>lp64_product<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>Heap Memoryì— Dataê°€ ì˜¬ë¼ê°ˆ ë•Œ, 8ì˜ ë°°ìˆ˜ë¥¼ ìœ ì§€í•˜ë„ë¡ í•œë‹¤ëŠ” ê²ƒì´ë‹¤.</p>

<p>ì´ ê°’ì´, ë” ì»¤ì§ˆ ê²½ìš° ì–´ë–¤ ì¥/ë‹¨ì ì´ ìˆëŠ”ì§€ëŠ” êµ¬ê¸€ë§ ìë£Œì— ë§ìœ¼ë‚˜ ì´í•´ê°€ ë˜ì§€ ì•Šì•˜ë‹¤.</p>
<p style="height:20px;"></p>
<p>ê°€ë ¹ ìœ„ì—ì„œ ì‚´í´ë³¸ _obj Object ì˜ SizeëŠ” header + length + Data = 12 + 4 + 500 = 516 bytes ì´ë‹¤.</p>

<p>Heap ì— ì €ì¥ë  ë•Œ, 8 bytes ì˜ ë°°ìˆ˜ ë‹¨ìœ„ë¡œ Dataì˜ ì •ë ¬ì´ ì´ë£¨ì–´ì ¸ì•¼ í•˜ë¯€ë¡œ,</p>

<p><code class="language-plaintext highlighter-rouge">8 X 65 = 520 bytes</code> , 8ì˜ 65 ë°°ìˆ˜ë¡œ Dataê°€ ì •ë ¬ì´ ë˜ì–´ì•¼ í•œë‹¤.</p>

<p>ê·¸ë¦¬í•˜ì—¬, <strong>Data ì •ë ¬ì„ ìœ„í•œ gap ìœ¼ë¡œ 4 bytes ë¥¼ ë§ˆì € ì¶”ê°€</strong>í•œ ê²ƒì´ë‹¤.</p>
<p style="height:40px;"></p>
<h3 id="311-shallow-size-of-bytesession">3.11 Shallow Size of byteSession</h3>

<p>Appì—ì„œ ìƒì„±(_obj) í•˜ì—¬ Sessionì— ì§‘ì–´ë„£ì„ ë•Œ, byteSession (Sessionì— ì €ì¥ëœ byte Array) ì˜ í¬ê¸°ë¥¼ ì¶”ì í•´ë³¸ë‹¤.</p>

<p>ì¶”ì  codeëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>    <span class="c1">// byteSession</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--- Layout : byteSession ---"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Shallow : "</span> <span class="o">+</span> <span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">byteSession</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Retained : "</span> <span class="o">+</span> <span class="nc">GraphLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">byteSession</span><span class="o">).</span><span class="na">totalSize</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">et</span><span class="o">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>1íšŒ í˜¸ì¶œ ì‹œì—ëŠ”, _obj Dataì™€ ë‹¤ë¥´ì§€ ì•Šë‹¤.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>--- Layout : byteSession ---
Shallow : [B object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00000067e900d701 (hash: 0x67e900d7; age: 0)
  8   4        (object header: class)    0x000007a8
 12   4        (array length)            500
 16 500   byte [B.&lt;elements&gt;             N/A
516   4        (object alignment gap)
Instance size: 520 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

Retained : 520
</pre></td></tr></tbody></table></code></pre></div></div>
<p style="height:20px;"></p>
<p>2íšŒ ì—°ì† í˜¸ì¶œ ì‹œì—ëŠ”,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>--- Layout : _tmp ---
Shallow : [B object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4        (object header: class)    0x000007a8
 12   4        (array length)            1000
 16 1000   byte [B.&lt;elements&gt;             N/A
Instance size: 1016 bytes
Space losses: 0 bytes internal + 0 bytes external = 0 bytes total

Retained : 1016
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">8 X 127 = 1016 Bytes</code>, 8ì˜ 127 ë°°ìˆ˜ë¡œ ì •ë ¬ì´ ì™„ë£Œë˜ë¯€ë¡œ ì¶”ê°€ Gap dataê°€ ì—†ë‹¤.</p>
<p style="height:20px;"></p>
<p>3íšŒ ì—°ì† í˜¸ì¶œ ì‹œì—ëŠ”,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>--- Layout : byteSession ---
Shallow : [B object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x00000036a33af901 (hash: 0x36a33af9; age: 0)
  8   4        (object header: class)    0x000007a8
 12   4        (array length)            1500
 16 1500   byte [B.&lt;elements&gt;             N/A
1516   4        (object alignment gap)
Instance size: 1520 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total

Retained : 1520
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ë‹¤ì‹œê¸ˆ 4 bytes Gap ì´ ì¶”ê°€ë˜ì—ˆë‹¤.</p>
<p style="height:40px;"></p>
<h2 id="4-outcome">4. Outcome</h2>

<p>JOL Library ë¥¼ ì‚¬ìš©í•˜ì—¬, íŠ¹ì • ë˜ëŠ” Class ìì²´ê°€ JVM Heap Memoryì— ì°¨ì§€í•˜ëŠ” ì‹¤ì œ Sizeë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŒì„ í™•ì¸í–ˆë‹¤.</p>

<p>ë˜í•œ, Object Alignment Gap ì— ëŒ€í•´ì„œ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.</p>
<p style="height:40px;"></p>
<h2 id="5-references">5. References</h2>

<p>https://www.baeldung.com/jvm-measuring-object-sizes</p>

<p>https://github.com/openjdk/jol</p>

<p><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html">ObjectAlignmentInBytes</a></p>
:ET